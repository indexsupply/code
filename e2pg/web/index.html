<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"><title>E2PG</title>
		<style>
			body {
				font-family: system-ui;
				max-width: 800px;
				margin: 0 auto;
			}
			.header {
				display: flex;
				flex-direction: row;
				align-items: baseline;
				justify-content: space-between;
			}
			.taskHeader {
				width: 100%;
				display: flex;
				flex-direction: row;
				justify-content: flex-start;
				align-items: baseline;
				gap: 20px;
				margin-bottom: 10px;
				color: dimgray;
			}
			.taskHeader .NRows, .taskHeader .Latency , .taskHeader .Hash, .taskHeader .Num {
				font-family: system-ui;
				text-transform: capitalize;
			}
			.task {
				margin-bottom: 10px;
				padding-bottom: 10px;
			}
			.task:not(:only-child) {
				border-bottom: 1px dotted dimgray;
			}
			.source {
				width: 100%;
				display: flex;
				flex-direction: row;
				justify-content: flex-start;
				align-items: baseline;
				gap: 20px;
				font-size: x-large;
			}
			.destinations :first-child {
				margin-top: 5px;
			}
			.destination .Name::before {
				content: "- ";
			}
			.destination {
				font-size: medium;
				width: 100%;
				display: flex;
				flex-direction: row;
				justify-content: flex-start;
				align-items: baseline;
				gap: 20px;
			}
			.Name {
				width: 25%;
				text-transform: capitalize;
			}
			.NRows {
				width: 10%;
				text-transform: lowercase;
				text-align: right;
				font-family: monospace;
			}
			.Latency {
				width: 10%;
				text-transform: lowercase;
				text-align: left;
				font-family: monospace;
			}
			.Num {
				width: 20%;
				text-transform: lowercase;
				text-align: left;
				font-family: monospace;
				padding-left: 20px;
			}
			.Hash {
				width: 20%;
				text-transform: lowercase;
				text-align: left;
				font-family: monospace;
				overflow: hidden;
				text-overflow: ellipsis;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<h1>E2PG</h1>
			<div>
				<a href="/add-source">Add Source</a>,
				<a href="/add-integration">Add Integration</a>
			</div>
		</div>
		<div class="taskHeader">
			{{ if (gt (len .SourceConfigs) 0) -}}
			<div class="Name"></div>
			<div class="NRows">Rows</div>
			<div class="Latency"><span>Latency</span></div>
			<div class="Hash"><span>Hash</span></div>
			<div class="Num"><span>Number</span></div>
			{{ end -}}
		</div>
		<div class="tasks">
			{{ range $sc := .SourceConfigs -}}
				{{ $tid  := (printf "%d-main" $sc.ChainID) -}}
				{{ with $tu := (index $.TaskUpdates $tid) -}}
				<div class="task" id="{{ $tid }}">
					<div class="source">
						<div class="Name">{{ $sc.Name }}</div>
						<div class="NRows">{{ $tu.NRows }}</div>
						<div class="Latency">{{ $tu.Latency }}</div>
						<div class="Hash">{{(printf "0x%x" $tu.Hash)}}</div>
						<div class="Num addComma">{{ $tu.Num }}</div>
					</div>
					<div class="destinations" style="display:none;">
						{{ range $name, $stat := $tu.Dstat -}}
						<div class="destination" id="{{ $tu.ID }}-{{$name}}">
							<div class="Name">{{ $name }}</div>
							<div class="NRows">{{ $stat.NRows }}</div>
							<div class="Latency">{{ $stat.Latency }}</div>
						</div>
						{{ end -}}
					</div>
				</div>
				{{ end -}}
			{{ end -}}
		</div>
	</body>
	<script>
		function comma(s) {
			return Number(s).toLocaleString();
		};
		function update(id, field, val) {
			const taskDiv = document.getElementById(id);
			const fieldDiv = taskDiv.querySelector(`.${field}`);
			fieldDiv.innerText = val;
		};
		document.addEventListener("DOMContentLoaded", function() {
			document.addEventListener('keydown', function(e) {
				if (e.keyCode == 73) {
					document.querySelectorAll('.destinations').forEach(el => {
						const d = el.style.display;
						el.style.display = (d == 'none' ? '' : 'none');
					});
				}
			});

			document.querySelectorAll(".addComma").forEach(e => {
				e.innerText = comma(e.innerText);
			});
			let updates = new EventSource("/task-updates");
			updates.onmessage = function(event) {
				const tu = JSON.parse(event.data);
				update(tu.ID, "Num", comma(tu.Num));
				update(tu.ID, "Hash", tu.Hash);
				update(tu.ID, "Latency", tu.Latency);
				update(tu.ID, "NRows", tu.NRows);
				for (const [k1, v1] of Object.entries(tu.Dstat)) {
					for (const [k2, v2] of Object.entries(v1)) {
						update(`${tu.ID}-${k1}`, k2, v2);
					}
				}
			};
		});
	</script>
</html>
